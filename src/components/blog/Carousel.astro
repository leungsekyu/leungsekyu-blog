---
import { Image } from 'astro:assets'
import astro from '@assets/astro.jpg'
import thayWalkingMeditation from '@assets/thay-walking-meditation.webp'

interface Props {
  id: string
}

const { id } = Astro.props
---

<div class="swiper leungsekyu" data-carousel-id={id}>
  <div class="swiper-wrapper">
    <div class="swiper-slide">
      <Image src={astro} alt="Astro's hero image." />
    </div>
    <div class="swiper-slide">
      <Image src={thayWalkingMeditation} alt="Thay's leading a walking meditation." />
    </div>
    <div class="swiper-slide">Slide 3 Slide 3 Slide 3 Slide 3</div>
  </div>

  <div class="swiper-button-prev"></div>
  <div class="swiper-button-next"></div>

  <div class="swiper-pagination"></div>
</div>

<style lang="scss">
  .swiper {
    --swiper-theme-color: #333;
    --swiper-pagination-bullet-inactive-color: #999;
    --swiper-pagination-bullet-inactive-opacity: 0.8;

    width: 100%;
    max-width: 653.109px;
    height: auto;
    aspect-ratio: 16/10;

    @media (max-width: 768px) {
      aspect-ratio: 4/3;

      &-button-prev,
      &-button-next {
        width: 32px;
        height: 32px;

        &::after {
          font-size: 14px;
        }
      }
    }

    @media (max-width: 480px) {
      aspect-ratio: 4/3;

      .swiper-button-prev,
      .swiper-button-next {
        display: none; // 移动端隐藏箭头
      }
    }

    &-slide {
      background: transparent;
      font-size: 18px;
      display: flex;
      justify-content: center;
      align-items: center;

      img {
        width: auto;
        height: auto;
        max-width: 100%;
        max-height: 100%;
      }
    }

    &-button-prev,
    &-button-next {
      width: 40px;
      height: 40px;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;

      &::after {
        font-size: 16px;
        color: #333;
      }

      &:hover {
        background-color: rgba(255, 255, 255, 1);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
      }
    }
  }
</style>

<script>
  import Swiper from 'swiper'
  import { Navigation, Pagination, Autoplay } from 'swiper/modules'

  import 'swiper/css'
  import 'swiper/css/navigation'
  import 'swiper/css/pagination'
  import 'swiper/css/autoplay'

  const swiperInstances = new Map()

  document.addEventListener('astro:page-load', () => {
    // 获取页面上所有的 Swiper 容器
    const swiperElements = document.querySelectorAll('.swiper')

    swiperElements.forEach((element) => {
      const carouselId = element.getAttribute('data-carousel-id')

      // 为每个 Swiper 容器创建一个新的实例
      const swiper = new Swiper(`[data-carousel-id="${carouselId}"]`, {
        modules: [Navigation, Pagination, Autoplay],
        loop: true,
        slidesPerView: 1, // 同时只显示一张图片
        speed: 800,
        effect: 'slide', // 明确使用滑动效果
        centeredSlides: false, // 改为 false，让图片对齐容器边缘
        autoplay: {
          delay: 2500,
          disableOnInteraction: false,
          pauseOnMouseEnter: true,
        },
        pagination: {
          el: '.swiper-pagination',
          clickable: true,
        },
        navigation: {
          nextEl: '.swiper-button-next',
          prevEl: '.swiper-button-prev',
        },
      })

      // 将实例存储在 Map 中
      swiperInstances.set(carouselId, swiper)
      console.log(`Swiper 组件 ${carouselId} 被初始化`)
    })
  })

  // 在页面切换前销毁 Swiper 实例
  document.addEventListener('astro:before-preparation', () => {
    swiperInstances.forEach((swiper, id) => {
      if (swiper) {
        swiper.destroy(true, true) // true, true 参数表示同时删除所有附加的事件监听器和HTML元素
        console.log(`Swiper 组件 ${id} 被销毁`)
      }
    })
    swiperInstances.clear() // 清空 Map
  })
</script>
